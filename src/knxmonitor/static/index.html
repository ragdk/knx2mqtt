<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KNX Monitor</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --accent: #22c55e;
      --muted: #9ca3af;
      --border: #1f2937;
      --text: #e5e7eb;
      --warn: #f59e0b;
      --danger: #ef4444;
      --card: #0b1221;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Fira Code", "JetBrains Mono", "SFMono-Regular", "Menlo", monospace;
      background: radial-gradient(120% 120% at 20% 20%, rgba(34, 197, 94, 0.1), transparent 45%), var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(90deg, rgba(34, 197, 94, 0.15), transparent 40%), var(--panel);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    h1 {
      margin: 0;
      font-size: 1.3rem;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    h1 span {
      padding: 0.25rem 0.5rem;
      border-radius: 0.35rem;
      background: rgba(34, 197, 94, 0.15);
      color: var(--accent);
      font-size: 0.8rem;
    }
    h2 {
      margin: 0 0 0.2rem;
      font-size: 1.05rem;
    }
    main { padding: 1rem 1.5rem 2rem; display: grid; gap: 1rem; }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 1rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
    }
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
      align-items: center;
    }
    .controls label {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      color: var(--muted);
      font-size: 0.9rem;
    }
    input[type="text"] {
      padding: 0.55rem 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
    }
    .buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    button {
      background: var(--accent);
      border: none;
      color: #04210f;
      padding: 0.55rem 0.9rem;
      border-radius: 0.55rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
    }
    button.secondary { background: var(--border); color: var(--text); }
    button:hover { transform: translateY(-1px); box-shadow: 0 10px 30px rgba(34, 197, 94, 0.2); }
    button:active { transform: translateY(0); box-shadow: none; }
    .status {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
      font-size: 0.95rem;
      color: var(--muted);
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.3rem 0.65rem;
      border-radius: 999px;
      background: var(--card);
      border: 1px solid var(--border);
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--danger);
      box-shadow: 0 0 0 6px rgba(239, 68, 68, 0.15);
    }
    .dot.ok { background: var(--accent); box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.15); }
    .table-wrap { overflow: auto; border-radius: 0.75rem; border: 1px solid var(--border); }
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      min-width: 720px;
    }
    th, td {
      padding: 0.65rem 0.75rem;
      border-bottom: 1px solid var(--border);
      text-align: left;
      font-size: 0.93rem;
    }
    th { color: var(--muted); font-weight: 600; background: rgba(255,255,255,0.02); position: sticky; top: 0; }
    tr:hover td { background: rgba(34, 197, 94, 0.04); }
    .muted { color: var(--muted); }
    .ga-summary {
      display: grid;
      gap: 0.75rem;
    }
    .hidden { display: none; }
    .ga-summary-header {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .ga-summary-columns {
      display: grid;
      grid-template-columns: 1fr 1.4fr 0.9fr 0.8fr 0.6fr;
      gap: 0.35rem;
      padding: 0.35rem 0.65rem;
      border-radius: 0.55rem;
      background: rgba(255, 255, 255, 0.03);
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
    }
    .ga-summary-list {
      display: grid;
      gap: 0.5rem;
      max-height: 220px;
      overflow-y: auto;
      padding-right: 0.25rem;
    }
    .ga-item {
      display: grid;
      grid-template-columns: 1fr 1.4fr 0.9fr 0.8fr 0.6fr;
      gap: 0.35rem;
      padding: 0.55rem 0.65rem;
      border-radius: 0.55rem;
      background: var(--card);
      border: 1px solid var(--border);
    }
    .ga-destination { font-weight: 700; }
    .ga-type { color: var(--muted); }
    .ga-value { color: var(--accent); font-weight: 600; }
    .ga-unit { color: var(--muted); }
    @media (max-width: 768px) {
      header { position: static; }
      table { min-width: 0; }
      .ga-item { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>KNX Monitor <span>live</span></h1>
  </header>

  <main>
    <section class="panel">
      <div class="controls">
        <label>
          Device
          <input id="filter-device" type="text" placeholder="Comma-separated (e.g. 1/2/3, Kitchen)">
        </label>
        <label>
          Device name
          <input id="filter-device-name" type="text" placeholder="e.g. Touch panel">
        </label>
        <label>
          Destination
          <input id="filter-destination" type="text" placeholder="e.g. 2/3/4">
        </label>
        <label>
          Destination name
          <input id="filter-destination-name" type="text" placeholder="e.g. Valve actuator">
        </label>
        <label>
          Type
          <input id="filter-type" type="text" placeholder="e.g. temperature">
        </label>
        <label>
          KNX Msg Type
          <input id="filter-knx-message-type" type="text" placeholder="e.g. GROUP_WRITE">
        </label>
        <label>
          Unit
          <input id="filter-unit" type="text" placeholder="e.g. °C">
        </label>
        <label>
          Value
          <input id="filter-value" type="text" placeholder="e.g. 22, on">
        </label>
        <label>
          Direction
          <input id="filter-direction" type="text" placeholder="e.g. Incoming, Outgoing">
        </label>
        <label style="grid-column: 1 / -1;">
          Describe what to monitor
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <input id="nl-query" type="text" placeholder="e.g. Troubleshoot heat control in the cantina" style="flex: 1 1 320px;">
            <button id="nl-run" type="button">Interpret</button>
            <button id="clear-filters" type="button" class="secondary">Clear filters</button>
          </div>
          <small id="nl-status" class="muted"></small>
        </label>
        <label style="grid-column: 1 / -1;">
          <div class="buttons">
            <button id="pause">Pause</button>
            <button id="clear" class="secondary">Clear</button>
            <button id="sort-time" class="secondary">Sort: newest first</button>
          </div>
        </label>
        <label style="grid-column: 1 / -1;">
          <div class="status">
            <span class="pill"><span class="dot" id="status-dot"></span><span id="status-text">connecting…</span></span>
            <span class="pill">Total: <strong id="count">0</strong></span>
            <span class="pill">Shown: <strong id="shown">0</strong></span>
          </div>
        </label>
      </div>
    </section>

    <section class="panel ga-summary hidden" id="ga-summary-panel">
      <div class="ga-summary-header">
        <div>
          <h2>Group address snapshot</h2>
          <div class="muted">Latest values for filtered destinations.</div>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
          <button id="ga-read" type="button">KNX read filtered</button>
          <small id="ga-status" class="muted"></small>
        </div>
      </div>
      <div class="ga-summary-columns" id="ga-summary-columns">
        <div>Group address</div>
        <div>GA name</div>
        <div>Type</div>
        <div>Value</div>
        <div>Unit</div>
      </div>
      <div class="ga-summary-list" id="ga-summary-list"></div>
    </section>

    <section class="panel table-wrap">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Device</th>
            <th>Device name</th>
            <th>Destination</th>
            <th>Destination name</th>
            <th>Type</th>
            <th>Value</th>
            <th>Unit</th>
            <th>KNX Msg Type</th>
            <th>Direction</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </section>
  </main>

  <script>
    const tableBody = document.getElementById("table-body");
    const filterInputs = {
      deviceid: document.getElementById("filter-device"),
      device_name: document.getElementById("filter-device-name"),
      destination: document.getElementById("filter-destination"),
      destination_name: document.getElementById("filter-destination-name"),
      type: document.getElementById("filter-type"),
      knx_message_type: document.getElementById("filter-knx-message-type"),
      unit: document.getElementById("filter-unit"),
      value: document.getElementById("filter-value"),
      direction: document.getElementById("filter-direction"),
    };
    const countEl = document.getElementById("count");
    const shownEl = document.getElementById("shown");
    const pauseBtn = document.getElementById("pause");
    const clearBtn = document.getElementById("clear");
    const sortBtn = document.getElementById("sort-time");
    const nlInput = document.getElementById("nl-query");
    const nlBtn = document.getElementById("nl-run");
    const clearFiltersBtn = document.getElementById("clear-filters");
    const nlStatus = document.getElementById("nl-status");
    const statusDot = document.getElementById("status-dot");
    const statusText = document.getElementById("status-text");
    const gaPanel = document.getElementById("ga-summary-panel");
    const gaColumns = document.getElementById("ga-summary-columns");
    const gaList = document.getElementById("ga-summary-list");
    const gaReadBtn = document.getElementById("ga-read");
    const gaStatus = document.getElementById("ga-status");

    let gaIndex = {};
    const latestByDest = new Map();
    let messages = [];
    let paused = false;
    let sortAsc = false; // default newest first
    let ws;
    let reconnectDelay = 750;
    let currentGaDestinations = [];

    function formatTime(ts) {
      const d = new Date(ts);
      if (isNaN(d.getTime())) return ts;
      return d.toLocaleTimeString(undefined, { hour12: false }) + " " + d.toLocaleDateString();
    }

    function parseTerms(value) {
      return value.split(",").map(v => v.trim()).filter(Boolean);
    }

    function fieldMatches(fieldValue, terms) {
      if (!terms.length) return true;
      const hay = String(fieldValue ?? "").toLowerCase();
      return terms.some(term => hay.includes(term.toLowerCase()));
    }

    function matchesFilters(msg) {
      const filters = {
        deviceid: parseTerms(filterInputs.deviceid.value),
        device_name: parseTerms(filterInputs.device_name.value),
        destination: parseTerms(filterInputs.destination.value),
        destination_name: parseTerms(filterInputs.destination_name.value),
        type: parseTerms(filterInputs.type.value),
        knx_message_type: parseTerms(filterInputs.knx_message_type.value),
        unit: parseTerms(filterInputs.unit.value),
        value: parseTerms(filterInputs.value.value),
        direction: parseTerms(filterInputs.direction.value),
      };
      return (
        fieldMatches(msg.deviceid, filters.deviceid) &&
        fieldMatches(msg.device_name, filters.device_name) &&
        fieldMatches(msg.destination, filters.destination) &&
        fieldMatches(msg.destination_name, filters.destination_name) &&
        fieldMatches(msg.type ?? msg.message_type, filters.type) &&
        fieldMatches(msg.knx_message_type, filters.knx_message_type) &&
        fieldMatches(msg.unit, filters.unit) &&
        fieldMatches(msg.value, filters.value) &&
        fieldMatches(msg.direction, filters.direction)
      );
    }

    function destinationsFilterActive() {
      return parseTerms(filterInputs.destination.value).length > 0;
    }

    function looksLikeAddress(term) {
      return /\\d/.test(term) && term.includes("/");
    }

    function formatDpt(meta) {
      if (!meta) return "-";
      const main = meta.dpt_main;
      const sub = meta.dpt_sub;
      if (main == null) return "-";
      if (sub == null) return `DPT ${main}`;
      return `DPT ${main}.${String(sub).padStart(3, "0")}`;
    }

    function filteredGroupAddresses() {
      const terms = parseTerms(filterInputs.destination.value);
      if (!terms.length) return [];
      const addresses = Object.keys(gaIndex);
      if (!addresses.length) {
        return terms.slice().sort((a, b) => a.localeCompare(b));
      }
      const matched = addresses.filter(addr => fieldMatches(addr, terms));
      const matchedSet = new Set(matched);
      terms.forEach(term => {
        if (!matchedSet.has(term) && looksLikeAddress(term)) {
          matched.push(term);
        }
      });
      return matched.sort((a, b) => a.localeCompare(b));
    }

    function trackLatest(msg) {
      const dest = msg.destination;
      if (!dest) return;
      const ts = new Date(msg.timestamp).getTime();
      if (Number.isNaN(ts)) return;
      const existing = latestByDest.get(dest);
      if (!existing || ts > existing.timestamp) {
        latestByDest.set(dest, { msg, timestamp: ts });
      }
    }

    function updateGroupSummary(filteredMessages) {
        const active = destinationsFilterActive();
        if (!active) {
          gaPanel.classList.add("hidden");
          gaPanel.style.display = "none";
          gaColumns.classList.add("hidden");
          gaColumns.style.display = "none";
          gaList.innerHTML = "";
          gaStatus.textContent = "";
          currentGaDestinations = [];
          gaReadBtn.disabled = true;
          return;
        }

        const fromIndex = filteredGroupAddresses();
        const destinations = fromIndex;
        currentGaDestinations = destinations;
        gaPanel.classList.toggle("hidden", false);
        gaPanel.style.display = "grid";
        gaColumns.classList.toggle("hidden", false);
        gaColumns.style.display = "grid";
        gaReadBtn.disabled = currentGaDestinations.length === 0;
        gaList.innerHTML = destinations.length ? destinations.map(dest => {
          const meta = gaIndex[dest];
          const latest = latestByDest.get(dest);
          const msg = latest?.msg;
          const name = meta?.name || msg?.destination_name || "-";
          const type = msg?.type || msg?.message_type || formatDpt(meta);
          const value = msg?.value ?? "-";
          const unit = msg?.unit || meta?.unit || "-";
          return `
          <div class="ga-item">
            <div class="ga-destination">${dest}</div>
            <div class="muted">${name}</div>
            <div class="ga-type">${type}</div>
            <div class="ga-value">${value}</div>
            <div class="ga-unit">${unit}</div>
          </div>
        `;
        }).join("") : '<div class="muted">No group addresses match the current filter.</div>';
    }

    function render() {
      const sorted = [...messages].sort((a, b) => {
        const at = new Date(a.timestamp).getTime();
        const bt = new Date(b.timestamp).getTime();
        return sortAsc ? at - bt : bt - at;
      });
      const filtered = sorted.filter(matchesFilters);
      shownEl.textContent = filtered.length;

      tableBody.innerHTML = filtered.map(m => `
        <tr>
          <td class="muted">${formatTime(m.timestamp)}</td>
          <td>${m.deviceid ?? "—"}</td>
          <td>${m.device_name ?? "—"}</td>
          <td>${m.destination ?? "—"}</td>
          <td>${m.destination_name ?? "—"}</td>
          <td>${m.type ?? m.message_type ?? "—"}</td>
          <td>${m.value ?? "—"}</td>
          <td>${m.unit ?? "—"}</td>
          <td>${m.knx_message_type ?? "—"}</td>
          <td>${m.direction ?? "—"}</td>
        </tr>
      `).join("");
      updateGroupSummary(filtered);
    }

    function updateStatus(ok, text) {
      statusDot.classList.toggle("ok", ok);
      statusText.textContent = text;
    }

    function clearFilters() {
      Object.values(filterInputs).forEach(input => input.value = "");
      nlInput.value = "";
    }

    function connect() {
      const proto = location.protocol === "https:" ? "wss" : "ws";
      const url = `${proto}://${location.host}/ws`;
      updateStatus(false, "connecting…");
      ws = new WebSocket(url);

      ws.onopen = () => {
        updateStatus(true, "connected");
        reconnectDelay = 750;
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "snapshot" && Array.isArray(data.messages)) {
          messages = data.messages;
          data.messages.forEach(trackLatest);
          countEl.textContent = messages.length;
        } else {
          messages.push(data);
          trackLatest(data);
          countEl.textContent = Number(countEl.textContent) + 1;
        }
        if (!paused) render();
      };

      ws.onclose = () => {
        updateStatus(false, "reconnecting…");
        setTimeout(connect, reconnectDelay);
        reconnectDelay = Math.min(reconnectDelay * 1.5, 5000);
      };
    }

    async function loadGaIndex() {
      try {
        const res = await fetch("/api/ga-index");
        if (!res.ok) {
          gaIndex = {};
          return;
        }
        const data = await res.json();
        gaIndex = data.group_addresses || {};
      } catch (err) {
        gaIndex = {};
      }
    }

    Object.values(filterInputs).forEach(input => input.addEventListener("input", render));
    pauseBtn.addEventListener("click", () => {
      paused = !paused;
      pauseBtn.textContent = paused ? "Resume" : "Pause";
      if (!paused) render();
    });
    clearBtn.addEventListener("click", () => {
      messages = [];
      countEl.textContent = "0";
      render();
    });
    clearFiltersBtn.addEventListener("click", () => {
      clearFilters();
      nlStatus.textContent = "";
      render();
    });
    sortBtn.addEventListener("click", () => {
      sortAsc = !sortAsc;
      sortBtn.textContent = sortAsc ? "Sort: oldest first" : "Sort: newest first";
      render();
    });
    nlBtn.addEventListener("click", async () => {
      const query = nlInput.value.trim();
      if (!query) return;
      nlStatus.textContent = "Interpreting…";
      try {
        const res = await fetch("/api/nl-filter", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query }),
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.detail || `Request failed (${res.status})`);
        }
        const data = await res.json();
        clearFilters();
        if (data.devices?.length) {
          filterInputs.deviceid.value = data.devices.join(", ");
        }
        if (data.destinations?.length) {
          filterInputs.destination.value = data.destinations.join(", ");
        }
        nlStatus.textContent = data.explanation || "Applied filters from NL query.";
        render();
      } catch (err) {
        nlStatus.textContent = `NL filter failed: ${err.message}`;
      }
    });
    nlInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        nlBtn.click();
      }
    });

    gaReadBtn.addEventListener("click", async () => {
      if (!currentGaDestinations.length) return;
      gaReadBtn.disabled = true;
      gaStatus.textContent = "Requesting KNX read…";
      try {
        const res = await fetch("/api/read-group-addresses", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ destinations: currentGaDestinations }),
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.detail || `Request failed (${res.status})`);
        }
        const data = await res.json();
        gaStatus.textContent = `Read requested for ${data.count} destination(s).`;
      } catch (err) {
        gaStatus.textContent = `Read request failed: ${err.message}`;
      } finally {
        gaReadBtn.disabled = currentGaDestinations.length === 0;
      }
    });

    loadGaIndex().finally(connect);
  </script>
</body>
</html>
